version: 2
models:
  - name: fct_orders
    description: "Order-level facts for KPI"
    columns:
      - name: order_total
        meta:
          metrics:
            total_revenue:
              type: sum
              format: '$#,##0'
      - name: subtotal
        meta:
          metrics:
            net_sales:
              type: sum
              format: '$#,##0'
      - name: tax_paid
        meta:
          metrics:
            tax_collected:
              type: sum
              format: '$#,##0'
      - name: order_id
        meta:
          metrics:
            orders:
              type: count_distinct
      - name: customer_id
        meta:
          metrics:
            unique_customers:
              type: count_distinct
      - name: items_count
        meta:
          metrics:
            items_sold:
              type: sum
    meta:
      group_label: "KPI"
      metrics:
        aov:
          type: number
          sql: ${net_sales} / NULLIF(${orders},0)
          format: '$#,##0.00'
          description: 'Average order value'
        items_per_order:
          type: number
          sql: ${items_sold} / NULLIF(${orders},0)
          format: '#,##0.00'
        gmv_running_total:
          type: running_total
          sql: ${total_revenue}
          description: 'Running total revenue'
        gross_profit:
          type: number
          sql: ${net_sales} - SUM(${ref('fct_orders')}.cogs_amount)
          format: '$#,##0'
          desctiption: 'Net sales minus cost of goods sold'
        gross_margin_pct:
          type: number
          sql: ( ${gross_profit} / NULLIF(${net_sales},0) )
          format: '0.0%'
          description: 'Gross profit / Net sales'
